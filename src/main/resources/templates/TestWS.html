<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Prueba WebSocket STOMP JSON libre</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body style="font-family: monospace; padding: 20px; background-color: #202020; color: #eee;">
<h2>Prueba STOMP - Env√≠o manual de JSON</h2>

<p>Estado: <span id="status">Desconectado</span></p>

<label>URL WebSocket (SockJS):</label><br>
<input id="wsUrl" type="text" value="http://localhost:8220/entry"
       style="width:350px; padding:5px; background:#111; color:#0f0; border:1px solid #555;">
<button id="connectBtn">Conectar</button>

<hr>

<label>Destino STOMP (MessageMapping):</label><br>
<input id="destination" type="text" value="/app/getEntryByUserID"
       style="width:350px; padding:5px; background:#111; color:#0f0; border:1px solid #555;" disabled>

<br><br>

<label>Topic a suscribirse (por ejemplo /topic/entriesByUser):</label><br>
<input id="topicInput" type="text" value="/topic/entriesByUser"
       style="width:350px; padding:5px; background:#111; color:#0f0; border:1px solid #555;" disabled>
<button id="subscribeBtn" disabled>Suscribirse</button>

<br><br>

<textarea id="jsonInput" rows="6" cols="60"
          style="background:#111; color:#0f0; padding:10px;"
          disabled>
{
  "key": 6
}
</textarea>
<br>
<button id="sendBtn" disabled>Enviar JSON</button>

<h3>Logs:</h3>
<pre id="log" style="background:#000; color:#0f0; padding:10px; height:250px; overflow:auto;"></pre>

<script>
    let client = null;
    let connected = false;

    const log = (txt) => {
        const el = document.getElementById('log');
        el.textContent += txt + '\n';
        el.scrollTop = el.scrollHeight;
    };

    const setConnected = (flag) => {
        connected = flag;
        document.getElementById('jsonInput').disabled = !flag;
        document.getElementById('sendBtn').disabled = !flag;
        document.getElementById('destination').disabled = !flag;
        document.getElementById('topicInput').disabled = !flag;
        document.getElementById('subscribeBtn').disabled = !flag;
        document.getElementById('status').textContent = flag ? "Conectado ‚úÖ" : "Desconectado";
    };

    document.getElementById('connectBtn').onclick = () => {
        const url = document.getElementById('wsUrl').value.trim();
        if (!url) {
            log("‚ùå URL inv√°lida");
            return;
        }

        log("üîå Conectando a: " + url + "...");

        const socket = new SockJS(url);
        client = new StompJs.Client({
            webSocketFactory: () => socket,
            debug: (str) => log(str),
            reconnectDelay: 0
        });

        client.onConnect = () => {
            setConnected(true);
            log("‚úÖ Conectado al broker STOMP");
        };

        client.onWebSocketError = (err) => log("‚ùå Error WebSocket: " + err);
        client.onStompError = (frame) => log("‚ö†Ô∏è STOMP Error: " + frame.headers["message"]);

        client.activate();
    };

    document.getElementById('subscribeBtn').onclick = () => {
        if (!connected) {
            log("‚ö†Ô∏è No est√°s conectado a√∫n");
            return;
        }

        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) {
            log("‚ö†Ô∏è Ingresa un topic v√°lido (ej: /topic/entriesByUser)");
            return;
        }

        log("üì° Suscribi√©ndose a: " + topic);

        client.subscribe(topic, (message) => {
            try {
                const data = JSON.parse(message.body);
                log("üì© Mensaje recibido en " + topic + ":\n" + JSON.stringify(data, null, 2));
            } catch {
                log("üì© Mensaje recibido (texto): " + message.body);
            }
        });
    };

    document.getElementById('sendBtn').onclick = () => {
        if (!connected) {
            log("‚ö†Ô∏è Con√©ctate primero");
            return;
        }

        const destination = document.getElementById('destination').value.trim();
        if (!destination) {
            log("‚ö†Ô∏è Debes especificar un destino STOMP (por ejemplo /app/getEntryByUserID)");
            return;
        }

        try {
            const raw = document.getElementById('jsonInput').value;
            const parsed = JSON.parse(raw);

            client.publish({
                destination: destination,
                body: JSON.stringify(parsed),
                headers: { "content-type": "application/json" }
            });

            log("üì§ Enviado a " + destination + ":\n" + JSON.stringify(parsed, null, 2));
        } catch (e) {
            log("‚ùå JSON inv√°lido: " + e.message);
        }
    };
</script>
</body>
</html>
